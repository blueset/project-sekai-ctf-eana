<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project SEKAI Online Judge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script src="https://code.iconify.design/2/2.2.1/iconify.min.js"></script>
    <script src="/static/vs/loader.js"></script>
</head>
<body class="text-white bg-zinc-800">
    <div class="w-screen h-screen flex flex-row">
        <aside class="min-w-[200px] max-w-[400px] w-1/3 flex flex-col overflow-y-auto p-4" id="aside">
            <h1 class="text-xs text-white/75 uppercase tracking-wide">Project SEKAI Online Judge</h1>
            <h2 class="text-xl font-semibold">Challenge Name</h2>
            <a class="px-4 py-2 rounded bg-cyan-700 hover:bg-cyan-600 disabled:bg-zinc-700 disabled:hover:bg-zinc-700 my-2 text-center" href="https://example.com/" target="_blank">Download PDF</a>
            <select name="language" id="language" class="bg-transparent my-2 border border-white/25 rounded p-2">
                <option value="python">Python 3</option>
                <option value="cpp">C++</option>
                <option value="typescript">TypeScript</option>
            </select>
            <div class="grow"></div>
            <button id="submit" class="text-center h-12 px-4 py-2 rounded bg-cyan-700 hover:bg-cyan-600 disabled:bg-zinc-700 disabled:hover:bg-zinc-700 my-2">Submit</button>
            <h3 class="text-lg font-semibold">Submissions</h3>
        </aside>
        <main class="grow basis-0 overflow-hidden" id="codeEditor">
            
        </main>
    </div>
    <script>
        window.submissions = 0;

        require.config({ paths: { vs: 'static/vs' } });
        require(['vs/editor/editor.main'], function () {
            monaco.editor.setTheme('vs-dark');
            var editor = window.editor = monaco.editor.create(document.getElementById('codeEditor'), {
                value: `print("Hello World!")\n`,
                language: 'python',
                fontFamily: `"Cascadia Code PL", "Cascadia Code", monospace`, 
                fontLigatures: `'calt', 'ss01'`,
                fontSize: 16,
                automaticLayout: true,
            });

            window.onresize = function (){
                editor.layout();
            };
        });

        var language = document.getElementById("language");
        language.addEventListener("change", function(evt) {
            monaco.editor.setModelLanguage(window.editor.getModel(), evt.target.value);
        });

        var submit = document.getElementById("submit");
        var aside = document.getElementById("aside");

        function onFinish() {
            submit.disabled = false;
            submit.classList.remove("bg-zinc-700");
            submit.classList.add("bg-cyan-700");
            submit.classList.add("hover:bg-cyan-600");
            submit.innerHTML = "Submit";
        }

        submit.addEventListener("click", function(evt) {
            evt.preventDefault();
            submit.disabled = true;
            submit.classList.remove("bg-cyan-700");
            submit.classList.add("bg-zinc-700");
            submit.classList.remove("hover:bg-cyan-600");
            submit.innerHTML = `<span class="iconify inline-block" data-icon="line-md:loading-loop"></span>`;

            fetch("/submit", {
                method: "POST",
                body: JSON.stringify({
                    language: language.value,
                    code: window.editor.getValue(),
                }),
                headers: {
                    "Content-Type": "application/json",
                },
            })
            .then((resp) => resp.json())
            .then((data) => {
                console.log(data);
                window.submissions++;
                var section = document.createElement("section");
                var cases = data.testCases.map((e) => {
                    if (e.status === "correct") return `<li class="inline-block mr-1" data-tippy-content="<b>Correct</b><br>Time: ${e.timeMs} ms<br>Memory: ${e.memoryKb} KB"><span class="iconify text-green-400" data-icon="ic:baseline-check-circle"></span></li>`;
                    else if (e.status === "wrongAnswer") return `<li class="inline-block mr-1" data-tippy-content="<b>Wrong Answer</b><br>Time: ${e.timeMs} ms<br>Memory: ${e.memoryKb} KB"><span class="iconify text-red-400" data-icon="ic:baseline-cancel"></span></li>`;
                    else if (e.status === "compilationError") return `<li class="inline-block mr-1" data-tippy-content="<b>Compilation failed</b>"><span class="iconify text-red-400" data-icon="codicon:bracket-error"></span></li>`;
                    else if (e.status === "runTimeError") return `<li class="inline-block mr-1" data-tippy-content="<b>Runtime Error</b>"><span class="iconify text-red-400" data-icon="ic:baseline-running-with-errors"></span></li>`;
                    else if (e.status === "timeLimitExceeded") return `<li class="inline-block mr-1" data-tippy-content="<b>Time Limit Exceeded</b><br>Time: ${e.timeMs} ms<br>Memory: ${e.memoryKb} KB"><span class="iconify text-red-400" data-icon="ic:baseline-hourglass-empty"></span></li>`;
                    else return JSON.stringify(e);
                }).join("");
                section.innerHTML = `<h4 class="font-medium">Submission ${window.submissions}</h4><ul class="text-2xl my-2">${cases}</ul>`;
                if (data.flag) {
                    section.innerHTML += `<code class="text-green-400">${data.flag}</code>`;
                }
                aside.appendChild(section);
                tippy('[data-tippy-content]', {allowHTML: true});
                onFinish();
            })
            .catch(() => {
                onFinish();
            });
        });
    </script>
</body>
</html>